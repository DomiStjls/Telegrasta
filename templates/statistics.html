{% extends "base.html" %}

{% block content %}
<h1 class="text-center mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞</h1>
<h1 class="text-center mb-4">–ö–ª—é—á —Å–µ—Å—Å–∏–∏: {{ key }}</h1>
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4 p-4">
    <form id="filter-form" class="row g-3">
        <div class="col-md-3">
            <label for="start" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
            <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
        </div>
        <div class="col-md-3">
            <label for="end" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
            <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
        </div>
        <div class="col-md-6">
            <label class="form-label">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</label>
            <div id="sentiments" class="d-flex flex-wrap gap-2">
                {% for sentiment in sentiments %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="{{ sentiment }}" id="sentiment-{{ loop.index }}">
                    <label class="form-check-label" for="sentiment-{{ loop.index }}">
                        {{ sentiment }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
    </form>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å PDF -->
<div class="text-end mb-4">
    <a href="/download_report" class="btn btn-primary">üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</a>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑ -->
<div id="statistics">
    <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h2>
    <div id="histogram">
        <img src="{{ histogram }}" class="img-fluid" />
    </div>

    <h2 class="mt-4">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h2>
    <div id="weekday">
        <img src="{{ sentiment_weekday }}" class="img-fluid" />
    </div>

    <h2 class="mt-4">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</h2>
    <div id="hour">
        <img src="{{ sentiment_hour }}" class="img-fluid" />
    </div>

    <h2 class="mt-4">–ß–∞—Å—Ç—ã–µ —Å–ª–æ–≤–∞</h2>
    <div id="top-words">
        
        <img src="{{ top_words }}" class="img-fluid" />
    </div>

    <h2 class="mt-4">–¢–æ–ø —ç–º–æ–¥–∑–∏</h2>
    <div id="emoji">
        <img src="{{ top_emoji }}" class="img-fluid" />
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("filter-form");
    const plots = ["histogram", "sentiment_weekday", "sentiment_hour", "top_words", "top_emoji"];

    function getSelectedSentiments() {
        const checkboxes = document.querySelectorAll("#sentiments input[type='checkbox']");
        let selected = [];
        checkboxes.forEach(cb => {
            if (cb.checked) selected.push(cb.value);
        });
        return selected.join(",");
    }

    async function updatePlots() {
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const sentiments = getSelectedSentiments();

        for (const plotType of plots) {
            const response = await fetch(`/plot/${plotType}?start=${start}&end=${end}&sentiments=${sentiments}`);
            const html = await response.text();
            document.getElementById(plotType).innerHTML = html;
        }
    }

    form.addEventListener("change", updatePlots);
});
</script>

{% endblock %}
