{% extends "base.html" %}

{% block content %}

<h1 class="text-center mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞</h1>
<h1 class="text-center mb-4"><label for="key" class="form-label">–ö–ª—é—á —Å–µ—Å—Å–∏–∏</label>
    <input class="form-control" id="key" name="key" value="{{ key }}" readonly>
</h1>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div class="card mb-4 p-4">
    <form id="filter-form" class="row g-3" method="get" action="/statistics/{{ key }}">
        <div class="col-md-3">
            <label for="start" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
            <input type="date" class="form-control" id="start" name="start" value="{{ start_date }}">
        </div>
        <div class="col-md-3">
            <label for="end" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
            <input type="date" class="form-control" id="end" name="end" value="{{ end_date }}">
        </div>
        <div class="col-md-6">
            <label class="form-label">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</label>
            <div id="sentiments" class="d-flex flex-wrap gap-2">
                {% for sentiment in all_sentiments %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="{{ sentiment }}"
                        id="sentiment-{{ loop.index }}" name="sentiments_new" {% if sentiment in sentiments
                        %}checked{% endif %}>
                    <label class="form-check-label" for="sentiment-{{ loop.index }}">
                        {{ sentiment }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <label for="authors" class="form-label">–ê–≤—Ç–æ—Ä—ã</label>
            <div id="authors" class="d-flex flex-wrap gap-2">
                {% for author in all_authors %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="{{ author }}"
                        id="sentiment-{{ loop.index }}" name="authors_new" {% if author in authors%}checked{% endif %}>
                    <label class="form-check-label" for="author-{{ loop.index }}">
                        {{ author }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
    </form>
</div>
<h2 style="text-align: center;" class="mt-4">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                <p class="card-text">{{ general.total_messages }}</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ê–≤—Ç–æ—Ä—ã</h5>
                <p class="card-text">{{ general.authors | join(', ') }}</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–±—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                <p class="card-text">{{ general.sentiment_percent.positive }}%</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                <p class="card-text">{{ general.sentiment_percent.neutral }}%</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ü—Ä–æ—Ü–µ–Ω—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                <p class="card-text">{{ general.sentiment_percent.negative }}%</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ö—Ç–æ —á–∞—â–µ –ø–∏—à–µ—Ç –ø–µ—Ä–≤—ã–º</h5>
                <p class="card-text">{{ general.first_speaker }}</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">–ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
                <p class="card-text">{{ general.peak_hour }}:00 - {{ (general.peak_hour + 1) % 24 }}:00</p>
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑ -->
<div id="statistics">
    <h2 style="text-align: center;" class="mt-4">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º</h2>
    <div id="histogram">
        <img src="{{ histogram }}" class="img-fluid" />
    </div>

    <h2 style="text-align: center;" class="mt-4">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h2>
    <div id="weekday">
        <img src="{{ sentiment_weekday }}" class="img-fluid" />
    </div>

    <h2 style="text-align: center;" class="mt-4">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</h2>
    <div id="hour">
        <img src="{{ sentiment_hour }}" class="img-fluid" />
    </div>

    <h2 style="text-align: center;" class="mt-4">–ß–∞—Å—Ç—ã–µ —Å–ª–æ–≤–∞</h2>
    <div id="top-words">

        <img src="{{ top_words }}" class="img-fluid" />
    </div>

    <h2 style="text-align: center;" class="mt-4">–¢–æ–ø —ç–º–æ–¥–∑–∏</h2>
    <div id="emoji">
        <h3 style="font-size: 2em; text-align: center;">{{ top_emoji }}</h3>
    </div>
</div>


<h2 style="text-align: center;" class="mt-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
<table class="table table-bordered align-middle">
    <thead>
        <tr>
            <th>–ê–≤—Ç–æ—Ä</th>
            <th>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</th>
            <th>–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</th>
            <th>–°–∞–º–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ</th>
            <th>–°–∞–º–æ–µ –¥–ª–∏–Ω–Ω–æ–µ</th>
            <th>–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</th>
            <th>–î–æ–±—Ä—ã–µ (%)</th>
            <th>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ (%)</th>
            <th>–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ (%)</th>
            <th>–ü–∏–∫–æ–≤—ã–π —á–∞—Å</th>
        </tr>
    </thead>
    <tbody>
        {% for row in user_table %}
        <tr>
            <td>{{ row.from }}</td>
            <td>{{ row.total_messages }}</td>
            <td>{{ row.avg_length | round(0) }}</td>
            <td>{{ row.shortest_msg }}</td>
            <td>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#longest{{ loop.index }}">
                        –ü–æ–∫–∞–∑–∞—Ç—å
                    </button>
                    <div id="longest{{ loop.index }}" class="collapse mt-2">
                        {{ row.longest_msg }}
                    </div>
                </div>
            </td>
            <td>{{ row.avg_per_day | round(0) }}</td>
            <td>{{ row.positive | round(1, 'floor') }}</td>
            <td>{{ row.neutral | round(1, 'floor') }}</td>
            <td>{{ row.negative | round(1, 'floor') }}</td>
            <td>{{ row.peak_hour }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>


<!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å PDF -->
<div class="text-end mb-4">
    <a href="/download_report" class="btn btn-primary">üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</a>
</div>

<!-- JavaScript -->
<!-- <script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("filter-form");
    const plots = ["histogram", "sentiment_weekday", "sentiment_hour", "top_words", "top_emoji"];

    function getSelectedSentiments() {
        const checkboxes = document.querySelectorAll("#sentiments input[type='checkbox']");
        let selected = [];
        checkboxes.forEach(cb => {
            if (cb.checked) selected.push(cb.value);
        });
        return selected.join(",");
    }

    async function updatePlots() {
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const sentiments = getSelectedSentiments();
        const key = document.getElementById("key").value;

        for (const plotType of plots) {
            const response = await fetch(`/statistics/${key}?start=${start}&end=${end}`);
            const html = await response.text();
            document.getElementById(plotType).innerHTML = html;
        }
    }

    form.addEventListener("change", updatePlots);
});
</script> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}